---
stages:
  - static
  - secret-detection
  - renovate
  - build
  - test
  - train
  - review
  - deploy
  - publish
  - fuzz
  - dast
  - notify
  - dependabot
  - release

services:
  - name: redis:latest
    alias: redis

include:
  - project: nabla-group/infrastructure/ci-templates
    ref: main
    file: "/templates/default.gitlab-ci.yml"

  - project: nabla-group/infrastructure/ci-templates
    ref: main
    file: "/templates/deploy-nomad.gitlab-ci.yml"

  - project: nabla-group/infrastructure/ci-templates
    ref: main
    file: "/templates/test-python.gitlab-ci.yml"

  - project: nabla-group/infrastructure/ci-templates
    ref: main
    file: "/templates/javascript.gitlab-ci.yml"

  - project: nabla-group/infrastructure/ci-templates
    ref: main
    file: "/templates/data.gitlab-ci.yml"

  - project: nabla-group/infrastructure/ci-templates
    ref: main
    file: "/templates/mega-linter.gitlab-ci.yml"

  # - component: $CI_SERVER_FQDN/guided-explorations/ci-components/ultimate-auto-semversioning/ultimate-auto-semversioning@1.2.8

  - component: $CI_SERVER_FQDN/to-be-continuous/semantic-release/gitlab-ci-semrel@3.11.2
    inputs:
      dry-run: false
      changelog-enabled: true
      changelog-title: "My changelog"
      auto-release-enabled: true
      info-on: all

  - component: $CI_SERVER_FQDN/dependabot-gitlab/dependabot-standalone/template@3.23.0
    inputs:
      gitlab_access_token: gitlab-access-token
      github_access_token: github-access-token
    rules:
      - if: $PACKAGE_MANAGER_SET

  #- project: 'renovate-bot/renovate-runner'
  #  file: '/templates/renovate.gitlab-ci.yml'

  # - remote: https://gitlab.com/renovate-bot/renovate-runner/-/raw/v24.0.0/templates/renovate.gitlab-ci.yml
  - component: $CI_SERVER_FQDN/to-be-continuous/renovate/gitlab-ci-renovate@1.9.0

  - project: "renovate-bot/renovate-runner"
    file: "/templates/renovate-config-validator.gitlab-ci.yml"

  - component: gitlab.com/components/sast/sast@main

  # NOK - template: Cosign.gitlab-ci.yml

  - template: Security/API-Fuzzing.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: DAST.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.v2.gitlab-ci.yml
  # - template: Jobs/Dependency-Scanning.latest.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  # - template: Jobs/Container-Scanning.gitlab-ci.yml

  - component: $CI_SERVER_FQDN/components/code-quality-oss/codequality-os-scanners-integration/codequality-oss@1.1.5
  - component: $CI_SERVER_FQDN/components/code-quality-oss/codequality-os-scanners-integration/tflint@1.1.5
  - component: $CI_SERVER_FQDN/components/code-quality-oss/codequality-os-scanners-integration/hadolint@1.1.5

default:
  cache: &global_cache
    # key: $CI_COMMIT_REF_SLUG
    # Cache modules using lock file
    key:
      files:
        - package-lock.json
    paths:
      # This folder is cached between builds
      # https://docs.gitlab.com/ee/ci/yaml/#cache
      - node_modules/
      # # Cache modules in between jobs
      - .npm/
      # - public/
      # - vendor/
    policy: pull-push

# Tip: Insert the following variables anywhere below stages and include
variables:
  CI_IMAGE_PYTHON: python:3.12.10
  PROJECT_PYTHON_VERSION: "3.12"
  POETRY_VERSION: "2.2.1"
  CI_IMAGE_NPM: node:24-alpine # 24.11-alpine3.23
  # CI_REGISTRY: registry.gitlab.com
  OCI_REGISTRY: ${CI_REGISTRY}/${CI_PROJECT_NAMESPACE}
  TYPE_TRAINING: ""
  # MOUNT_POINT: "/builds/$CI_PROJECT_PATH/mnt"
  CI_IMAGE_NAME: ${CI_REGISTRY}/nabla-group/web/templates/jm-oci/jm-ubuntu
  CI_IMAGE_TAG: latest
  # GIT_STRATEGY: fetch
  GIT_DEPTH: "3"
  FLAVOR: "-python"
  TRIVY_VERSION: "0.68.2"
  TRIVY_SCANNERS: "vuln,misconfig,secret,license"
  CS_SEVERITY_THRESHOLD: "CRITICAL"
  CS_SEVERITY_FILESYTEM_THRESHOLD: "CRITICAL" # CRITICAL,HIGH
  TRIVY_GLOBAL_IGNORE_FILE: "--ignorefile .trivyignore.yaml"
  # TRIVY_GLOBAL_SECURITY_CHECKS_EXTRA: "--ignore-unfixed --ignorefile .trivyignore.yaml --ignored-licenses LGPL-2.0,LGPL-2.1,LGPL-3.0"
  # DD_GLOBAL_SECURITY_CHECKS_EXTRA: "--ignore-unfixed --ignorefile .trivyignore.yaml --ignored-licenses LGPL-2.0,LGPL-2.1,LGPL-3.0"
  TRIVY_ARGS: "--skip-dirs .direnv --skip-dirs .venv --skip-dirs .node_cache --skip-dirs code/node_modules/ --skip-dirs go/go/pkg/mod/github.com/ --skip-dirs /usr/bin/go/pkg/mod/github.com/ --skip-dirs code/.venv/ --skip-dirs node_modules --skip-dirs usr/lib/node_modules/ --skip-dirs root/.npm/ --skip-files pip.conf --skip-files Pipfile" #  --insecure  --debug
  DD_ARGS: "${TRIVY_ARGS}"
  TRIVY_FS_ARGS: "${TRIVY_ARGS}  --skip-files package-lock.json --skip-files yarn.lock"
  DD_PRODUCT_NAME: "$CI_PROJECT_NAME"
  DD_SERVICE: "test" # fastapi-sample
  DD_PRODUCT_TYPE_NAME: "Showcase Alban" # "Research and Development"
  DD_URL_UAT: "http://defectdojo.service.gra.uat.consul"
  DD_TEST_NAME: "JM Trivy"
  DD_MINIMUM_SEVERITY: "MEDIUM"
  DD_CLOSE_OLD_FINDINGS: "True"
  DD_CLOSE_OLD_FINDINGS_PRODUCT_SCOPE: "True"
  DD_DO_NOT_REACTIVATE: "False"
  DD_BRANCH_TAG: "${CI_COMMIT_TAG}" # CI_COMMIT_BRANCH CI_IMAGE_TAG
  CLOC_SOURCE: "nabla"
  # RUNNER_GENERATE_ARTIFACTS_METADATA: "true"
  # FF_NETWORK_PER_BUILD: "true" # enable network per build so all services can communicate on the same network
  APP_NAME: fastapi-sample
  NOMAD_ENV_DEPLOY: "-var env=${ENV} -var team=${ENV}"
  NOMAD_SERVICE_DEPLOY_URL_SUFFIX: docs # citemap/ping
  NOMAD_SERVICE_DEPLOY_URL: http://${APP_NAME}.service.gra.${ENV}.consul/${NOMAD_SERVICE_DEPLOY_URL_SUFFIX}
  DEFAULT_POETRY_OPT_GROUPS: "format,test,extra,open_telemetry,api,deployment,influxdb,panda,temporal,utils,webui"
  DEPENDENCY_UPDATES_DISABLED: false
  # GIT_CLONE_PATH: '$CI_BUILDS_DIR/$CI_PROJECT_NAME/$CI_PIPELINE_ID'
  # GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_CONCURRENT_ID/$CI_PROJECT_PATH
  MEGALINTER_EXIT_ON_FAILURE: 1
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"
  # Force-enable BuildKit in "docker build" commands (on Linux it is disabled by default)
  DOCKER_BUILDKIT: 1
  # Build the fully-qualified image name (including the registry server prefix), but without the ":version" suffix
  IMAGE_BASE_TAG: $CI_REGISTRY_IMAGE/fastapi-sample
  CONTAINER_IMAGE: $IMAGE_BASE_TAG:latest
  # Complement the base tag with various versions, one per image target/stage. We use the CI_COMMIT_REF_SLUG (which is
  # basically the branch/tag name, but slugified) to ensure that the cache images are also different for each branch.
  # This is done because the code that we compile/build/test in any specific branch might be different (from the
  # code of other branches), and the cache images would overwrite each other (if we had not appended the
  # "-$CI_COMMIT_REF_SLUG" suffix), causing cache misses!
  # TEST_CACHE_TAG: $IMAGE_BASE_TAG:test-cache-$CI_COMMIT_REF_SLUG
  TEST_CACHE_TAG: python:3.12-slim
  API_REPORTER_URL: http://loki-read.service.gra.uat.consul:3100/loki/api/v1/push
  API_REPORTER_BEARER_TOKEN: ""
  DEFAULT_COV_ARGS: "--no-ddtrace --no-cov" # --cov-fail-under=1
  # NETLIFY_SITE_ID: '8dc3759f-f33d-424d-9300-d21f859ca183'
  DAST_TARGET_URL: https://fastapi-sample.service.gra.${ENV}.consul
  DAST_AUTH_URL: "https://fastapi-sample.service.gra.${ENV}.consul/login"
  DAST_BROWSER_SCAN: "true" # use the browser-based GitLab DAST crawler
  DAST_FULL_SCAN_ENABLED: "true"
  # DAST_AUTH_USERNAME: “john”
  # DAST_AUTH_PASSWORD: “P@ssw0rd”
  FUZZAPI_TARGET_URL: https://fastapi-sample.service.gra.${ENV}.consul/openapi.json
  FUZZAPI_OPENAPI: https://fastapi-sample.service.gra.${ENV}.consul/openapi.json
  FUZZAPI_PROFILE: Quick-10
  CONTAINER_SCANNING_DISABLED: false
  CUSTOM_CONTAINER_SCANNING_DISABLED: "true"
  GITLAB_ADVANCED_SAST_ENABLED: true
  DS_ENFORCE_NEW_ANALYZER: "true"
  # RENOVATE_BASE_DIR: $CI_PROJECT_DIR/renovate
  RENOVATE_PLATFORM: gitlab
  RENOVATE_ONBOARDING_CONFIG: '{"$$schema": "https://docs.renovatebot.com/renovate-schema.json", "extends": ["config:recommended"] }'
  # RENOVATE_GIT_AUTHOR: "alban.andrieu@free.fr"
  RENOVATE_OPTIMIZE_FOR_DISABLED: "true"
  RENOVATE_REPOSITORY_CACHE: "true"
  RENOVATE_LOG_FILE: renovate-log.ndjson
  RENOVATE_EXTRA_FLAGS: --autodiscover=true --onboarding=false
  CI_RENOVATE_IMAGE: ghcr.io/renovatebot/renovate:41.152.9@sha256:3d4da143701edbedaebc7b43961614acc795fca272d71f533d15feb3296014c9
  RUNNER_GENERATE_ARTIFACTS_METADATA: "true"
  MEND_SCA_ORCHESTRATOR_ENABLED: "true"
  MEND_AI_ENABLE_CODE_CAPABILITIES: "true"
  CS_DISABLE_LANGUAGE_VULNERABILITY_SCAN: "false"
  SECRET_DETECTION_HISTORIC_SCAN: false
  IGNORE_NORMALISATION_GIT_HEAD_MOVE: "true"
  MEGALINTER_IMAGE_TAG: "v9.2.0"

.renovate:
  cache:
    key: ${CI_COMMIT_REF_SLUG}-renovate
    paths:
      - renovate/cache/renovate/repository/
  image: ${CI_RENOVATE_IMAGE}
  script:
    - renovate $RENOVATE_EXTRA_FLAGS

renovate:
  extends: .renovate
  stage: renovate
  resource_group: production
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  artifacts:
    when: always
    expire_in: 1d
    paths:
      - "$RENOVATE_LOG_FILE"

run_renovate:
  image: ${CI_RENOVATE_IMAGE}
  stage: renovate
  resource_group: production
  only:
    - schedules
  script:
    - renovate $RENOVATE_EXTRA_FLAGS

.dependabot-gitlab:
  stage: dependabot

secret_detection:
  stage: secret-detection

gemnasium-dependency_scanning:
  dependencies: ["docker-build"]

gemnasium-python-dependency_scanning:
  allow_failure: false # force pipeline to fail if this job fails

  before_script:
    - apt-get update -y && apt-get install -y jq

  script:
    - /analyzer run
    - HIGH_SEVERITY_COUNT=$(jq '.vulnerabilities | map(select(.severity=="High")) | length' gl-dependency-scanning-report.json )
    - >
      if [[ $HIGH_SEVERITY_COUNT -gt 0 ]]
      then
        echo "High severity found"; exit 1
      else
        echo "No High severity found"
      fi

# upload_trivy:uat:
#   extends: .upload_trivy:uat

# cloc:
#   extends: .cloc

# upload-cloc:uat:
#   extends: .upload-cloc:uat

gitlab_version:
  image:
    name: registry.gitlab.com/python-gitlab/python-gitlab:latest
    entrypoint: [""]
  before_script: gitlab --version
  script: gitlab namespace list || true

# ======
# Python Code Checks
# ======

.python-check: &python-check
  stage: test
  image: registry.gitlab.com/gitlab-data/data-image/ci-python-image:v1.0.0
  only:
    changes:
      - "**/*.ipynb"
    refs:
      - merge_requests
  allow_failure: true

.python-black:
  <<: *python-check
  script:
    - black --check .

lint-ruff:
  extends: .lint-ruff
  stage: static
  image: $CI_IMAGE_PYTHON
  interruptible: true
  allow_failure: true
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^.*(#dev|#uat|#team|#prod).*$/s"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Make CI NOT run on main branch
      when: never

type-checker-pyright:
  extends: .type-checker-pyright
  stage: static
  image: $CI_IMAGE
  interruptible: true
  allow_failure: true
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^.*(#dev|#uat|#team|#prod).*$/s"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Make CI NOT run on main branch
      when: never

test-pytest-poetry:
  extends: .test-pytest-poetry
  needs: ["lint-ruff", "type-checker-pyright"]
  variables:
    # DEFAULT_COV_ARGS: "--cov-fail-under=1" # We need to increase the test coverage
    DEFAULT_COV_ARGS: "--no-ddtrace --no-cov"
  allow_failure: false
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^.*(#dev|#uat|#team|#prod).*$/s"
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH # Make CI NOT run on main branch
      when: never

# pytest with pipenv
.test-pytest-pipenv:
  extends: .test-pytest
  needs: []
  image: $CI_IMAGE_PYTHON
  interruptible: true
  allow_failure: false
  variables:
    DEFAULT_COV_ARGS: "--no-ddtrace --no-cov"
    DEFAULT_PIPENV_ARGS: "--system --dev --ignore-pipfile"
    DEFAULT_PYTEST_PACKAGES: "pytest pytest-cov pytest-env"
    KEYCLOAK_SERVER_URL: "https://keycloak-https.service.gra.uat.consul"
    KEYCLOAK_REALM: "nabla"
    KEYCLOAK_CLIENT_ID: "nabla_uat"
    # KEYCLOAK_CLIENT_SECRET: ""
    # BELOW is needed as we do not use jm-ubuntu but python:3.10
  before_script:
    - !reference [.install-pip3, script]
    - !reference [.install-pipenv, script]
    - !reference [.pipenv-install, script]
  script:
    - python3 -m pip install --user ${DEFAULT_PYTEST_PACKAGES}
    - python3 -m pip install --user redis arel
    - python3 -m pipenv install --dev --site-packages --ignore-pipfile
    - export DB_URL=${DB_URL}
    - export POSTGRES_DRIVER="postgresql"
    - export POSTGRES_HOST="pg-gra.service.gra.dev.consul"
    - export POSTGRES_PORT="5432"
    - export POSTGRES_DB="fastapi_sample_gitlab"
    - export POSTGRES_USER=${POSTGRES_USER}
    - export POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    - export LOG_LEVEL=DEBUG
    - echo "ENV is :${ENV}"
    - pytest --cov=${DEFAULT_COV} --cov-report term --cov-report xml:coverage.xml --junitxml pytest-junit.xml ${DEFAULT_COV_ARGS}

test-pytest:
  extends: .test-pytest-poetry
  needs: []
  image: ${CI_IMAGE_PYTHON}
  interruptible: true
  allow_failure: false
  variables:
    DEFAULT_COV_ARGS: "--no-ddtrace --cov-fail-under=70"
    DEFAULT_PIPENV_ARGS: "--system --dev --ignore-pipfile"
    DEFAULT_PYTEST_PACKAGES: "pytest pytest-cov pytest-env"
    KEYCLOAK_SERVER_URL: "https://keycloak-https.service.gra.uat.consul"
    KEYCLOAK_REALM: "nabla"
    KEYCLOAK_CLIENT_ID: "nabla_uat"
    # KEYCLOAK_CLIENT_SECRET: ""
    REDIS_PORT: 6379
    REDIS_HOST: redis
    REDIS_URL: redis://redis:6379
    ENABLE_METRICS: false
  script:
    - pip install --upgrade pip
    - if [ -n "${DEFAULT_POETRY_OPT_GROUPS}" ]; then ${POETRY_HOME}/bin/poetry install --no-root --with ${DEFAULT_POETRY_OPT_GROUPS}; else ${POETRY_HOME}/bin/poetry install --no-root; fi
    - export DB_URL=${DB_URL}
    - export POSTGRES_DRIVER="postgresql"
    - export POSTGRES_HOST="pg-gra.service.gra.dev.consul"
    - export POSTGRES_PORT="5432"
    - export POSTGRES_DB="fastapi_sample_gitlab"
    - export POSTGRES_USER=${POSTGRES_USER}
    - export POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    - export LOG_LEVEL=DEBUG
    - echo "PATH = $PATH"
    - pytest --cov=${DEFAULT_COV} --cov-report term --cov-report xml:coverage.xml --junitxml pytest-junit.xml ${DEFAULT_COV_ARGS}

docker-build:
  extends: .docker-build
  variables:
    APP_IMAGE: $APP

# See https://docs.gitlab.com/user/packages/npm_registry/?tab=%60npm+config%60#publish-a-package-with-a-cicd-pipeline
install-npm:
  extends: .install-npm
  script:
    # - npm config set @scope:registry=git@gitlab.com:api/v4/groups/2454528/-/packages/npm/
    # - npm config set '@nabla-group:registry=git@gitlab.com:api/v4/projects/60435718/packages/npm/'
    # - npm config set '@nabla-group:registry=git@gitlab.com:api/v4/packages/npm/:_authToken='"${CI_JOB_TOKEN}"
    # - echo "@scope:registry=https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/" > ~/.npmrc
    - echo "@nabla-group:registry=git@gitlab.com:api/v4/packages/npm/" > ~/.npmrc
    # - echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> ~/.npmrc
    - echo "//${CI_SERVER_HOST}/api/v4/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> ~/.npmrc
    # - rm -rf node_modules package-lock.json
    - |
      if [ -e yarn.lock ]; then
        yarn install --frozen-lockfile
      elif [ -e package-lock.json ]; then
        npm i --cache .npm --prefer-offline --no-audit
      fi
  cache:
    # inherit all global cache settings
    <<: *global_cache
  artifacts:
    paths:
      - node_modules
    expire_in: 6 hours # your GitLab instance will have a default, you can override it like this
    when: on_success # don't attempt to upload the docs if generating them failed
  allow_failure: false

lint-eslint-npm:
  extends: .lint-eslint-npm
  script:
    - npm test --cache .npm
    - npx eslint --format gitlab .
  allow_failure: false
  cache:
    # inherit all global cache settings
    <<: *global_cache
    # override the policy
    policy: pull
  artifacts:
    reports:
      codequality: gl-codequality.json

unit-tests-npm:
  image: ${CI_IMAGE_NPM}
  extends: .unit-tests-npm
  needs: ["install-npm"]
  dependencies:
    - install-npm
  allow_failure: false
  cache:
    # inherit all global cache settings
    <<: *global_cache
    # override the policy
    policy: pull
  script:
    - cd vue-client/
    - export NPM_TOKEN=$CI_JOB_TOKEN
    - npm ci
    - npx nuxi prepare
    - npm run build

mega_linter:
  extends: .mega_linter_common
  needs: ["test-pytest"]
  tags:
    - nabla-nomad-runner
  allow_failure: false

.build-image-dockefile-pre: &build-image-dockefile-pre
  script:
    # --target builder-base
    - export DOCKER_BUILD_OPT="--pull --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from ${TEST_CACHE_TAG} -f Dockerfile --secret id=read-package-token,env=CI_PIP_GITLABNABLA_TOKEN --secret id=read-npm-token,env=CI_JOB_TOKEN --build-arg ENV=${ENV} -t ${CONTAINER_IMAGE}"
    - echo -e "\e[35mOverriden on purpose as Sample docker build need explicit \e[0m FOR \e[43m${ENV} - ${DOCKER_BUILD_OPT}.\e[0m"

code_quality:
  extends: .code_quality
  # stage: test
  needs: ["docker-build", "lint-ruff", "type-checker-pyright"]
  dependencies:
    - docker-build
    - lint-ruff
    - type-checker-pyright
  script:
    - |-
      if [[ $CONTAINER_SCANNING_GITLAB_CODEQUALITY_TEMPLATE_DISABLE != "true" ]]; then
        jq -s 'add' report_ruff.json report_pyright.json > gl-codeclimate.json || true;
      else
        echo "Disable report_ruff.json report_pyright.json report combine";
      fi

.terrascan:
  image:
    name: tenable/terrascan:1.18.3
    entrypoint: ["/bin/sh", "-c"]
  stage: static
  script:
    - /go/bin/terrascan scan . --skip-rules="AC_AWS_0214,AC_AWS_0148" --severity="high" --config-path ./terrascan.yaml || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - !reference [.default_rules, rules]

train-commit-activated:
  stage: train
  image: $CONTAINER_IMAGE
  tags:
    - saas-linux-medium-amd64-gpu-standard
  script:
    - echo "GPU training activated by commit message"
    - echo "message passed is $CI_COMMIT_MESSAGE"
    - notebookName=$(echo ${CI_COMMIT_MESSAGE/train})
    - echo "Notebook name $notebookName"
    - papermill -p is_local_development False -p tree_method 'gpu_hist' $notebookName -
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /\w+\.ipynb/
      when: always
      allow_failure: true
  artifacts:
    paths:
      - ./model_metrics.md

cml:
  stage: notify
  image: dvcorg/cml-py3:latest
  script:
    - cml-send-comment model_metrics.md
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /\w+\.ipynb/
      when: always
      allow_failure: true

publish-npm:
  image: ${CI_IMAGE_NPM}
  extends: .publish-npm
  needs: ["install-npm"]
  dependencies:
    - install-npm
  tags:
    - nabla-nomad-runner
  script:
    # If no .npmrc is included in the repo, generate a temporary one that is configured to publish to GitLab's NPM registry
    - |
      if [[ ! -f .npmrc ]]; then
        echo 'No .npmrc found! Creating one now. Please review the following link for more information: https://docs.gitlab.com/ee/user/packages/npm_registry/#with-the-npmrc-file'
        {
          echo "@${CI_PROJECT_ROOT_NAMESPACE}:registry=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/npm/"
          echo "${CI_API_V4_URL#http*:}/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=\${CI_JOB_TOKEN}"
        } >> .npmrc
      fi
    - echo "Created the following .npmrc:"; cat .npmrc
    # Extract a few values from package.json
    - NPM_PACKAGE_NAME=$(node -p "require('./package.json').name")
    - NPM_PACKAGE_VERSION=$(node -p "require('./package.json').version")

    # Validate that the package name is properly scoped to the project's root namespace.
    # For more information, see https://docs.gitlab.com/ee/user/packages/npm_registry/#package-naming-convention
    - |
      if [[ ! $NPM_PACKAGE_NAME =~ ^@$CI_PROJECT_ROOT_NAMESPACE/ ]]; then
        echo "Invalid package scope! Packages must be scoped in the root namespace of the project, e.g. \"@${CI_PROJECT_ROOT_NAMESPACE}/${CI_PROJECT_NAME}\""
        echo 'For more information, see https://docs.gitlab.com/ee/user/packages/npm_registry/#package-naming-convention'
        exit 1
      fi

    # Compare the version in package.json to all published versions.
    # If the package.json version has not yet been published, run `npm publish`.
    # If $SIGSTORE_ID_TOKEN is set this template will generate a provenance
    # document. For more information refer to the documentation: https://docs.gitlab.com/ee/ci/yaml/signing_examples/
    - |
      if [[ "$(npm view ${NPM_PACKAGE_NAME} versions)" != *"'${NPM_PACKAGE_VERSION}'"* ]]; then
        if [[ -n "${SIGSTORE_ID_TOKEN}" ]]; then
          npm publish --provenance
        else
          npm publish
        fi
        echo "Successfully published version ${NPM_PACKAGE_VERSION} of ${NPM_PACKAGE_NAME} to GitLab's NPM registry: ${CI_PROJECT_URL}/-/packages"
      else
        echo "Version ${NPM_PACKAGE_VERSION} of ${NPM_PACKAGE_NAME} has already been published, so no new version has been published."
      fi

deploy:dev:
  extends: .deploy:dev
  needs: ["docker-build"]
  tags:
    - nabla-nomad-runner

deploy:uat:
  extends: .deploy:uat
  needs: ["docker-build"]
  tags:
    - nabla-nomad-runner

deploy:prod:
  extends: .deploy:prod
  tags:
    - nabla-nomad-runner

pages-deploy:
  image: ${CI_IMAGE_NPM}
  dependencies: ["unit-tests-npm"]
  stage: publish
  before_script:
    - cd vue-client/
    - npm ci --cache .npm --prefer-offline
  script:
    - npx nuxi prepare
    - npm run generate
    # - npm run build
    - echo "npx serve .output/public"
    - mkdir ../public || true
    - cp -R ./dist/* ../public
  cache: # https://docs.gitlab.com/ee/ci/caching/#cache-nodejs-dependencies
    key:
      files:
        - package-lock.json
    paths:
      - .npm/
  artifacts:
    paths:
      # The directory that contains the built files to be published
      - .output/public
  pages:
    # publish: public
    publish: vue-client/.output/public
    path_prefix: "$PAGES_PREFIX"
  environment:
    name: "Pages ${PAGES_PREFIX}"
    url: "${CI_PAGES_URL}"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        PAGES_PREFIX: "mr-$CI_MERGE_REQUEST_IID"
      when: always

dast:
  dependencies: ["pages-deploy"]
  stage: dast
  tags:
    - nabla-nomad-runner
  variables:
    # DAST_TARGET_URL: "https://fastapi-sample.service.gra.${ENV}.consul"
    # DAST_AUTH_URL: "https://fastapi-sample.service.gra.${ENV}.consul/login"
    # DAST_AUTH_USERNAME_FIELD: "css:[name=username]"
    # DAST_AUTH_PASSWORD_FIELD: "css:[name=password]"
    # DAST_AUTH_SUBMIT_FIELD: "css:button[type=submit]"
    # DAST_TARGET_CHECK_TIMEOUT: "5m"  # Wait up to 5 minutes
    # DAST_AUTH_COOKIE_NAMES: "sessionID,refreshToken"
    # DAST_AUTH_SUCCESS_IF_AT_URL: "https://fastapi-sample.service.gra.${ENV}.consul/admin"
    DAST_SCOPE_EXCLUDE_URLS: "https://fastapi-sample.service.gra.${ENV}.consul/logout,/user/.*/logout"
    # DAST_BROWSER_SCAN: "true" # use the browser-based GitLab DAST crawler
    DAST_PAGE_READY_AFTER_NAVIGATION_TIMEOUT: "45s"
    DAST_PAGE_READY_AFTER_ACTION_TIMEOUT: "15s"
    DAST_PAGE_DOM_READY_TIMEOUT: "15s"
  dast_configuration:
    site_profile: "DAST API DEV"
    scanner_profile: "DAST Passive Test"

publish:
  image: ${CI_IMAGE_NPM}
  stage: release
  #   dependencies:
  #     - semantic-release-info
  script: echo $SEMREL_INFO_LAST_VERSION
    echo $SEMREL_INFO_NEXT_VERSION
    echo $SEMREL_INFO_NEXT_VERSION_TYPE
    npm run semantic-release
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

netlify:
  image: ${CI_IMAGE_NPM}
  stage: static
  script:
    - npm install -g netlify-cli
    - netlify --version

.netlify:review:
  image: ${CI_IMAGE_NPM}
  stage: review
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    url: $REVIEW_URL
  before_script:
    - npm install -g netlify-cli
    - apk add curl jq
  script:
    - netlify --version
    - netlify status
    - echo "Deploying to site $NETLIFY_SITE_ID"
    - netlify deploy -dir my-app/public --json | tee deploy-result.json
    - REVIEW_URL=$(jq -r '.deploy_url' deploy-result.json)
    - echo ${REVIEW_URL}
    - curl ${REVIEW_URL} | grep 'World'
    - echo "REVIEW_URL=$REVIEW_URL" > deploy.env
  artifacts:
    reports:
      dotenv: deploy.env
    expire_in: "10 days"
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
  allow_failure: true

.netlify:uat:
  image: ${CI_IMAGE_NPM}
  stage: deploy
  environment:
    name: staging
    url: "https://fastapi-sample.service.gra.uat.consul/"
  before_script:
    - npm install -g netlify-cli
    - apk add curl
  script:
    - netlify --version
    - netlify status
    - echo "Deploying to site $NETLIFY_SITE_ID"
    - netlify deploy --alias staging -dir my-app/public
    - curl $CI_ENVIRONMENT_URL | grep 'World'
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
  allow_failure: true

.netlify:prod:
  image: ${CI_IMAGE_NPM}
  stage: deploy
  when: manual
  environment:
    name: production
    url: https://my-app.bababou.workers.dev/'
  before_script:
    - npm install -g netlify-cli
    - apk add curl
  script:
    - netlify --version
    - netlify status
    - echo "Deploying to site $NETLIFY_SITE_ID"
    - netlify deploy --prod -dir my-app/public
    - curl 'https://my-app.bababou.workers.dev/' | grep 'World'
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
